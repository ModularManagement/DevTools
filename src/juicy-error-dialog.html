<link rel="import" href="../../polymer/polymer.html">

<polymer-element name="juicy-error-data" attributes="error">
  <script>
    Polymer("juicy-error-data", {
      error: null
    });
  </script>
</polymer-element>

<polymer-element name="juicy-error-dialog">
  <template>
    <style>
      :host {
        font-family: sans-serif;
      }

      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #overlay.hidden {
        display: none;
      }

      #dialog {
        background: white;
        box-shadow: 0 13px 25px 0 rgba(0, 0, 0, 0.3);
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
      }

      .errorHeader {
        background-color: firebrick;
        color: white;
        padding: 2px 24px;
        font-size: 80%;
      }

      .errorPad {
        margin: 24px;
      }
    </style>

    <div id="overlay" class="hidden">
      <div id="dialog">
        <template repeat="{{error in errors}}">
          <div class="errorHeader">Error {{error.errorNo}}</div>
          <div class="errorPad">
            <juicy-error-data error="{{error}}">
              <template bind ref="reporters"></template>
            </juicy-error-data>
          </div>
        </template>
        <content></content>
      </div>
    </div>
  </template>
  <script>
    Polymer("juicy-error-dialog", {
      errorNo: 0,
      limit: 10,
      errors: [],
      ready: function () {
        var that = this;
        var tpl = this.querySelector('template');
        tpl.id = "reporters";
        this.shadowRoot.appendChild(tpl);
        this._handleErrorEvent = function (ev) {
          that.errorNo++;
          ev.errorNo = that.errorNo;
          if (that.errors.length > that.limit) {
            return;
          }
          that.errors.push(ev);
          that.$.overlay.classList.remove("hidden");
        };
        window.addEventListener("error", this._handleErrorEvent);
        this.$.overlay.addEventListener("click", this.dialogClosed.bind(this));
      },
      dialogClosed: function () {
        this.$.overlay.classList.add("hidden");
        this.errors.length = 0;
      }
    });
  </script>
</polymer-element>
