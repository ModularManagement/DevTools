<link rel="import" href="/sys/polymer/polymer.html" />
<link rel="import" href="/sys/juicy-jsoneditor/src/juicy-jsoneditor.html" />
<script src="puppet-js-listener.js"></script>

<polymer-element name="puppet-js-patches" attributes="rows" constructor="PuppetJsPatchesElement">
    <template>
        <style>
            :host { width: 100%; overflow: auto; background-color: white; color: #333333; }
            table { width: 100%; border-collapse: collapse; padding: 0px; margin: 0px; border-left: 1px solid #dddddd; border-right: 1px solid #dddddd; }
            table th, table td { padding: 8px; border: 1px solid #dddddd; text-align: left; border-left: 0px; border-right: 0px; }
            table th { border-bottom-width: 2px; font-size: 110%; }
            table td.td-index { white-space: nowrap; width: 20px; }
            table td.td-type { white-space: nowrap; width: 30px; }
            table td.td-date { white-space: nowrap; width: 80px; }
            table td.td-duration { white-space: nowrap; width: 60px; }
            table td.td-code { white-space: nowrap; width: 50px; font-weight:bold; }
            table td.td-direction { white-space: nowrap; width: 70px; }
            table td.td-data { font-size: 10px; width: 100%; }
            table td.td-url input { width: 100%; box-sizing: border-box; border: 1px solid transparent; padding: 5px 8px; }
            table td.td-data textarea { width: 100%; box-sizing: border-box; border: 1px solid transparent; resize:none; }
            table tr.status-500 td, table tr.status-500 td input, table tr.status-500 td textarea { color: red; }
            table td.td-url input:hover, table td.td-data textarea:hover { border: 1px solid #dddddd; }
            table tr.tr-ws td.td-url { color: blue; }
            .btn { background-color: white; border: 2px solid #dddddd; padding: 6px 22px; margin: 8px 0px; display: inline-block; cursor: pointer; }
            .btn:hover { border-color: #333333; }
            .actions { overflow: auto; }
            .form-control { padding: 6px; border: 1px solid #dddddd; margin: 8px 0px; }
            .pull-right { float: right; }
            .direction-send { color: green; font-weight: bold; }
            .direction-send .receive { display:none; }
            .direction-receive { color: red; font-weight: bold; }
            .direction-receive .send { display: none; }
            .direction-state { display: none; }
        </style>
        <template if="{{editor.visible == false}}">
            <div class="actions">
                <button type="button" class="btn pull-right" on-click="{{clear}}">Clear log</button>
                <select value="{{filter.method}}" class="form-control">
                    <option value="all">All types</option>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="WS">WS</option>
                </select>
                <select value="{{filter.direction}}" class="form-control">
                    <option value="all">All direction</option>
                    <option value="send">Send</option>
                    <option value="receive">Receive</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Url</th>
                        <th>Code</th>
                        <th>Duration</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- <template id="results" repeat="{{row, i in filteredRows}}"> -->
                    <!-- IE needs some hacking: -->
                        <tr template class="status-{{row.statusCode}}" id="results" repeat="{{row, i in filteredRows}}">
                            <td class="td-index">{{i}}</td>
                            <td class="td-date">
                                <span title="{{row.date}}">{{row.time}}</span>
                            </td>
                            <td class="td-type">
                                <span>{{row.method}}</span>
                                <span class="direction-{{row.direction}}">
                                    <span class="send" title="Sent">→</span>
                                    <span class="receive" title="Received">←</span>
                                </span>
                            </td>
                            <td class="td-url">
                                <a title="{{row.url}}" href="{{row.url}}" target="_blank">{{row.path}}</a>
                            </td>
                            <td class="td-code">{{row.statusCode}}</td>
                            <td class="td-duration">{{row.duration}}</td>
                            <td class="td-data">
                                <template if="{{row.data}}">
                                    <textarea readonly="readonly" onclick="this.select();" ondblclick="getModel(this).editor.json = getModel(this).row.json; getModel(this).editor.visible = true;" title="Double click me to enter JSON viewer">{{row.data}}</textarea>
                                </template>
                            </td>
                        </tr>
                    <!-- </template> -->
                </tbody>
            </table>
        </template>
        <template if="{{editor.visible}}">
            <juicy-jsoneditor json="{{editor.json}}" mode="view" history="false"></juicy-jsoneditor>
            <div class="actions">
                <button type="button" class="btn pull-right" onclick="getModel(this).editor.visible = false;">Close</button>
            </div>
        </template>
    </template>
    <script>
        (function (gloabl) {
            var listener = gloabl.PuppetListener;
            window.rows = listener.rows;
            window.addEventListener("polymer-ready", function (e) {
                listener.startListen();
            });

            function filterRows(rows, filter) {
                var result = [];
                var method = filter.method;
                var direction = filter.direction;

                for (var i = 0; i < rows.length; i++) {
                    var is = true;
                    var row = rows[i];

                    is = is && (method == "all" || method == row.method);
                    is = is && (direction == "all" || (direction == row.direction));

                    if (is) {
                        result.push(row);
                    }
                }

                return result;
            }

            Polymer({
                // {Array} array of rows to consider
                rows: null,
                // {Object} Filter setup
                filter: null,
                // {Object} JSON editor config
                editor: null,
                filteredRows: null,
                // set default values
                created: function () {
                    this.filter = {
                        method: "all",
                        direction: "all",
                        clear: 0,
                    };
                    this.editor = {
                        json: null,
                        visible: false
                    };

                    this.rows = listener.rows;
                    this.filteredRows = listener.rows;
                },
                // observe filter changes
                observe: {
                    "filter.method": "filterRows",
                    "filter.direction": "filterRows"
                },
                // Update filteredRows property with filtered rows
                filterRows: function () {
                    this.filteredRows = filterRows(this.rows, this.filter);
                },
                // Splice rows
                clear: function () {
                    listener.clear();
                    this.filteredRows.splice(0, this.filteredRows.length);
                    this.filter.method = "all";
                    this.filter.direction = "all";
                }
            });
        })(window);
    </script>
</polymer-element>
