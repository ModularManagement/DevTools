<link rel="import" href="/sys/polymer/polymer.html" />
<script type="text/javascript" src="puppet-js-listener.js"></script>

<template>
    <style>
        label {
            margin-right: 5px;
        }

        label * {
            vertical-align: middle;
        }
    </style>
    <div>
        <label>
            <input type="checkbox" id="isWebSocket" />
            <span>WebSocket</span>
        </label>
        <span>&nbsp;</span>
        <label>
            <input type="checkbox" id="isMorphUrl" />
            <span>Morph url</span>
        </label>
    </div>
</template>

<script>
    (function (window, document) {
        var listener = window.PuppetListener;
        var thatDoc = document;
        var thisDoc = (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;
        var template = thisDoc.querySelector('template').content;
        var element = Object.create(HTMLElement.prototype);
        var settingName = {
            ws: "starcounter-debug-aid-puppet-js-useWebSocket",
            morph: "starcounter-debug-aid-puppet-js-morphUrls"
        };

        element.createdCallback = function () {
            this.createShadowRoot();
        };

        function parseBool(value, def) {
            if (typeof value == "undefined" || value === null) {
                return def;
            }

            if (!value || value == "false") {
                return false;
            } 

            return true;
        }

        function getSettingValue(name) {
            return parseBool(window.localStorage.getItem(name), true);
        }

        function applyWebSocketValue(value) {
            var puppet = listener.getPuppetClient();

            if (puppet) {
                puppet.useWebSocket = value;
            }

            window.localStorage.setItem(settingName.ws, value);
        }

        function applyMorphUrlValue(value) {
            var puppet = listener.getPuppetClient();

            if (puppet) {
                if (value) {
                    puppet.listen();
                } else {
                    puppet.unlisten();
                }
            }

            window.localStorage.setItem(settingName.morph, value);
        }

        element.attachedCallback = function () {
            var clone = thatDoc.importNode(template, true);
            var chbIsWebSocket = clone.querySelector("#isWebSocket");
            var chbIsMorphUrl = clone.querySelector("#isMorphUrl");

            chbIsWebSocket.checked = getSettingValue(settingName.ws);
            chbIsWebSocket.addEventListener('change', function (ev) {
                applyWebSocketValue(ev.target.checked);
            });

            chbIsMorphUrl.checked = getSettingValue(settingName.morph);
            chbIsMorphUrl.addEventListener("change", function (ev) {
                applyMorphUrlValue(ev.target.checked);
            });

            this.shadowRoot.appendChild(clone);
        };

        window.addEventListener("polymer-ready", function () {
            setTimeout(function () {
                applyWebSocketValue(getSettingValue(settingName.ws));
                applyMorphUrlValue(getSettingValue(settingName.morph))
            });
        });
        
        document.registerElement('puppet-js-settings', {
            prototype: element
        });
    }(window, document));
</script>
