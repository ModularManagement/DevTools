<link rel="import" href="/sys/polymer/polymer.html" />
<script type="text/javascript" src="puppet-js-listener.js"></script>

<template>
    <div>
        <label>
            <input type="checkbox" id="isWebSocket" />
            WebSocket
        </label>
    </div>
</template>

<script>
    (function (window, document) {
        var listener = window.PuppetListener;
        var thatDoc = document;
        var thisDoc = (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;
        var template = thisDoc.querySelector('template').content;
        var element = Object.create(HTMLElement.prototype);
        var settingName = "starcounter-debug-aid-puppet-js-useWebSocket";

        element.createdCallback = function () {
            this.createShadowRoot();
        };

        function isUseWebSocket(useWebSocketStr) {
            if (!useWebSocketStr) {
                return true;
            }
            else if (useWebSocketStr == "false") {
                return false;
            }
            else {
                return true;
            }
        }

        function getSettingValue() {
            return isUseWebSocket(window.localStorage.getItem(settingName));
        }

        function applyValue(value) {
            var puppet = listener.getPuppetClient();

            if (puppet) {
                puppet.useWebSocket = value;
            }

            window.localStorage.setItem(settingName, value);
        }

        element.attachedCallback = function () {
            var clone = thatDoc.importNode(template, true);
            var chb = clone.querySelector('#isWebSocket');

            chb.checked = getSettingValue();
            chb.addEventListener('change', function (ev) {
                applyValue(ev.target.checked);
            });

            this.shadowRoot.appendChild(clone);
        };

        applyValue(getSettingValue());
        document.registerElement('puppet-js-settings', {
            prototype: element
        });
    }(window, document));
</script>
